#lang racket

(require describe)
(require "gbwtgraph")
; (describe gfa-to-gbwtgraph)

(define graph-1 (gfa-to-gbwtgraph  "cerevisiae.pan.fa.0b30003.2ff309f.0967224.smooth.gfa"))

(define graph-2 (gfa-to-gbwtgraph "example_gfa1.gfa"))

(define graph-3 (gfa-to-gbwtgraph "example.gfa"))

(define vector_test (GRAPH-get-all-handles graph-1))


(define (first-node-handle gbwtgraph)
  (let ([first-node (GRAPH-min-node-id gbwtgraph)])
     (GRAPH-node-to-handle first-node)))

(define (initialize-searchState gbwtgraph)
   (let ([first-handle (first-node-handle gbwtgraph)])
    (GRAPH-get-state gbwtgraph first-handle)))


(define (random-node gbwt)
  (let
    ([max-node    (+ 1 (GRAPH-max-node-id gbwt))]
     [min-node    (GRAPH-min-node-id gbwt)])
    (random min-node max-node)))


(define  (random-handle gbwt)
  (let ([rnode (random-node gbwt)])
    (GRAPH-node-to-handle rnode)))


(define a-number (quotient (GRAPH-max-node-id  graph-1) 10))

(define state-1 (GRAPH-get-state graph-1 1))

; (define new-state  (GRAPH-extend graph-1  state-1 (+ a-number 1)))
; (SearchState-get-range state-1)
(SearchState-get-range state-1)

(define (extend-to-all-states graph)
  (letrec
   ([max-node    (+ 1 (GRAPH-max-node-id graph))]
    [min-node    (GRAPH-min-node-id graph)]
    [initial-state (GRAPH-get-state graph min-node)])
   (stream-map (位 (x) (GRAPH-extend graph initial-state x))  (in-range min-node (+ 1  max-node)))))

; (define    (get-states-and-frequencies graph-1))
(define all-ranges (extend-to-all-states  graph-1))



(define (partition-by-frequency ranges)
  (let loop ([acc (list)] [rst ranges] [n 1])
    (if (empty? ranges) 
      acc
     (let-values
             ([(p r) (partition (位 (x) (= n (cdr  (SearchState-get-range x)))) ranges)])
             (loop (append p acc) r (+ 1 n))))))

(define partitioned  (void))

(length partitioned)
; (set! partitioned 3)

(thread
  (位()
   (set! partitioned (partition-by-frequency  (stream->list  all-ranges)))))
; (length partitioned)
; (empty? '())
;
; (append '(32) '(554))

(define (find-max-frequency-state all-ranges)
 (stream-fold
   (位 (c x)
      (if (> (cdr  (SearchState-get-range x))
             (cdr  (SearchState-get-range c))) x c))
   (car  all-ranges) (cdr all-ranges)))



; (define max-state  (find-max-node-state all-ranges))

;(stream-ref all-ranges 2)

; (describe stream-map)
; (stream-ref  (in-range 2 44) 41)
; (SearchState-get-range state-1)

; (define state-1  (SearchState-get-range initial-state))
